# Архитектура

## Глобальные сценарии

### Начало новой игры
1. удалить из мира все сущности, содержащиеся в игровом поле;
1. создать новое игровое поле нужного размера;
1. для каждого элемента уровня:
    1. создать сущность в клетке игрового поля;
    1. добавить к сущности компоненты из элемента;

### Загрузка сохранения
1. удалить из мира все сущности, содержащиеся в игровом поле;
1. создать новое игровое поле нужного размера;
1. для каждой сущности из сохранения:
    1. создать новую сущность;
    1. скопировать в новую сущность компоненты;
    1. разместить сущность в игровом поле на основе значений компонентов;


## Работа систем

Все системы запускаются последовательно.

Следует различать ситуации **пусто** и **нет препятствия**.

**Пусто** - это вообще нет сущности.

**Нет препятствия** - это **пусто**, или сущность,
переместившаяся в другую клетку больше, чем наполовину.

**Есть препятствие** - это неподвижная сущность,
или сущность переместившаяся в другую клетку меньше, чем наполовину,
или сущность, перемещающаяся в эту клетку.

Компоненты воздействия (`Hit`, `Bite`, `Burn`) содержат координаты клетки
воздействия, чтобы знать где рисовать взрыв, если что.


### `MotionSystem`
1. выбрать в мире все сущности с компонентом `FieldMotion`;
1. изменить степень перемещения в соответствии с таймером;
1. если перемещение завершено - переместить сущность между клетками на игровом поле;


### `FallingSystem`
1. выбрать в мире все сущности с компонентом `Falling` и `FieldMotion`;
1. если движение в `FieldMotion` завершено
    1. если снизу есть препятствие -
        добавить компонент `Hit` к этой сущности и препятствию;
    1. удалить компонент `FieldMotion`;


### `StartFallingSystem`
1. выбрать в мире все сущности с компонентом `Falling` и без `FieldMotion`;
1. для всех сущностей, где снизу пусто - добавить компонент
    `FieldMotion` с движением вниз;


### `StartRollingSystem`
1. выбрать в мире все сущности с компонентом `Rolling` и без `FieldMotion`;
1. для всех сущностей, где снизу круглое неподвижное препятствие:
    1. если справа и справа внизу пусто - добавить `FieldMotion` с движением вправо;
    1. иначе если слева и слева внизу пусто - добавить `FieldMotion` с движением влево;


### `TurningSystem`
1. выбрать в мире все сущности с компонентом `Turning`;
1. изменить степень поворота в соответствии с таймером;
1. если поворот завершён - убрать компонент `Turning`;


### `SeekRightSystem`
1. выбрать в мире все сущности с компонентом `RoamingRight`
    без `FieldMotion` и `Turning`;
1. если справа от направления движения (компонент `Direction`) пусто -
    добавить компонент `Turning` с поворотом вправо и пропустить оставшиеся пункты;
1. если справа препятствие - добавить препятствию компонент `Bite`;
1. если спереди пусто - добавить компонент `FieldMotion` в направлении движения
    и пропустить оставшиеся пункты;
1. если спереди препятствие - добавить препятствию компонент `Bite`;
1. добавить компонент `Turning` с поворотом влево;    


### `SeekLeftSystem`
То же, что и `SeekRightSystem`, только зеркально.


### `ControlSystem`
1. найти сущность с компонентом `PlayerControl`;
1. 


### `BiteSystem`
1. выбрать в мире все сущности с компонентом `Bite`;
1. удалить у сущностей компонент `Bite`;
1. если есть компонент `BiteDestructible` - добавить компонент `Destroyed`;


### `HitSystem`
1. выбрать в мире все сущности с компонентом `Hit`;
1. удалить у сущностей компонент `Hit`;
1. если есть компонент `HitDestructible` - добавить компонент `Destroyed`;


### `BurnSystem`
1. выбрать в мире все сущности с компонентом `Burn`;
1. удалить у сущностей компонент `Burn`;
1. если есть компонент `BurnDestructible` - добавить компонент `Destroyed`;


### `ExplosionSystem`
1. выбрать в мире все сущности с компонентом `Destroyed`;
1. удалить сущность с поля и заменить взрывом;
1. если есть компонент `Explosive` - добавить компонент `Burn` всем соседям;


### `CleaningSystem`
1. выбрать в мире все сущности с компонентом `Destroyed`;
1. удалить выбранные сущности из мира;


### `RenderingSystem`
1. выбрать в мире все сущности с компонентом `Sprite` и `ScreenPosition`;
1. отобразить все спрайты;
1. выбрать в мире все сущности с компонентом `Text` и `ScreenPosition`;
1. отобразить все текстовые объекты;
